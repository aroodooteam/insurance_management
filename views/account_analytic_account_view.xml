<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>

        <act_window id="act_analytic_history_request"
            name="History"
            res_model="analytic.history"
            src_model="account.analytic.account"
            context="{'default_analytic_id': active_id}"
            view_mode="tree,form"
            view_id="insurance_management.view_analytic_history_tree"
            domain="[('analytic_id', '=', active_id)]"/>

        <record id="view_account_analytic_account_form" model="ir.ui.view">
            <field name="name">account.analytic.account.form</field>
            <field name="model">account.analytic.account</field>
            <field name="inherit_id" ref="account_analytic_analysis.account_analytic_account_form_form"/>
            <field name="arch" type="xml">
                <xpath expr="//h1" position="after">
                    <div name="insurance">
                        <field name="is_insurance"/>
                        <label for="is_insurance"/>
                    </div>
                </xpath>
                <field name="manager_id" position="after">
                    <field name="branch_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)]}"/>
                    <field name="ins_product_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)]}"/>
                    <field name="fraction_ids" placeholder="Insurance fractions" invisible="1"/>
                    <field name="fraction_id" widget="selection"/>
                </field>
                <field name="partner_id" position="replace">
                    <field name="partner_id" string="subscriber"/>
                    <field name="insured_id"/>
                </field>
                <xpath expr="//notebook" position="inside">
                    <page string="Risk" name="Risk" attrs="{'invisible': [('is_insurance', '=', False)]}">
                        <group colspan="4">
                            <field name="risk_line_ids" nolabel="1" context="{'default_history_id': active_id}">
                                <tree string="Risk Type" name="Risk Type">
                                    <field name="partner_id"/>
                                    <field name="type_risk_id"/>
                                    <field name="name"/>
                                </tree>
                                <form string="Risk Line">
                                    <group colspan="4">
                                        <!--<field name="history_id" invisible="1"/>-->
                                        <field name="analytic_id" invisible="1"/>
                                        <field name="ins_product_id" invisible="1"/>
                                        <field name="partner_id"/>
                                        <field name="type_risk_id" string="Risk Type"/>
                                        <field name="name"/>
                                        <field name="risk_warranty_tmpl_id" string="Warranty Lines Template" attrs="{'invisible': [('type_risk_id','=', False)]}"/>
                                    </group>
                                    <notebook colspan="4" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                        <page string="Warranty" name="Warranty" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                            <field name="warranty_line_ids" context="{'type_risk_id': type_risk_id}">
                                                <tree string="warranty" name="warranty" editable="top">
                                                    <field name="warranty_id"/>
                                                    <field name="name"/>
                                                </tree>
                                            </field>
                                        </page>
                                        <page string="Descriptions" name="Descriptions" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                            <field name="risk_description_ids">
                                                <tree string="Descriptions" create="false" editable='top'>
                                                    <field name="code" readonly="1"/>
                                                    <field name="name" readonly="1"/>
                                                    <field name="value"/>
                                                </tree>
                                            </field>
                                        </page>
                                    </notebook>
                                </form>
                            </field>
                        </group>
                    </page>
                </xpath>
                <xpath expr="//div[@name='buttons']" position="inside">
                    <button name="%(act_analytic_history_request)d" type="action" class="oe_stat_button" icon="fa-calendar" attrs="{'invisible': [('history_count','=', 0)]}">
                        <field name="history_count" widget="statinfo" string="History"/>
                    </button>
                </xpath>
            </field>
        </record>

        <record id="act_open_account_analytic_account_view" model="ir.actions.act_window">
            <field name="name">Policy</field>
            <field name="res_model">account.analytic.account</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{'default_type':'contract', 'search_default_open':1, 'search_default_pending':1, 'default_manager_id':uid}</field>
            <field name="domain">[('type','=','contract')]</field>
            <field name="search_view_id" ref="account_analytic_analysis.view_account_analytic_account_overdue_search"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new contract.
                </p><p>
                    Use contracts to follow tasks, issues, timesheets or invoicing based on
                    work done, expenses and/or sales orders. Odoo will automatically manage
                    the alerts for the renewal of the contracts to the right salesperson.
                </p>
            </field>
        </record>

        <menuitem id="menu_account_analytic_account"
            parent="insurance_management.menu_root_operation_insurance"
            sequence="20"
            action="act_open_account_analytic_account_view"/>

    </data>
</openerp>
