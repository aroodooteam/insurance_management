<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>

        <!--
        <act_window id="act_analytic_history_request"
            name="History"
            res_model="analytic.history"
            src_model="account.analytic.account"
            context="{'default_analytic_id': active_id}"
            view_mode="tree,form"
            view_id="insurance_management.view_analytic_history_tree"
            domain="[('analytic_id', '=', active_id)]"/>
        -->

                    <!--
                    <button name="%(act_analytic_history_request)d" type="action" class="oe_stat_button" icon="fa-calendar" attrs="{'invisible': [('history_count','=', 0)]}">
                        <field name="history_count" widget="statinfo" string="History"/>
                    </button>
                    -->
        <record id="view_account_analytic_account_form" model="ir.ui.view">
            <field name="name">account.analytic.account.form</field>
            <field name="model">account.analytic.account</field>
            <field name="inherit_id" ref="analytic.view_account_analytic_account_form"/>
            <field name="arch" type="xml">
                <xpath expr="/form/sheet" position="before">
                    <header>
                        <field name="state" readonly="1" widget="statusbar"
                            statusbar_visible="draft,open,pending,suspend,close,cancelled"
                            statusbar_colors='{"pending":"red", "template":"blue"}'/>
                    </header>
                </xpath>
                <xpath expr='//div[@name="project"]' position='inside'>
                    <div name="insurance">
                        <field name="is_insurance"/>
                        <label for="is_insurance"/>
                    </div>
                </xpath>
                <xpath expr="//div[@name='buttons']" position="inside">
                    <button
                        name="open_analytic_history_wiz"
                        class="oe_stat_button"
                        string="New version" type="object"
                        icon="fa-file-o"/>
                    <button name="open_history_list" class="oe_stat_button" type="object" icon="fa-list-alt" attrs="{'invisible': [('history_count','=', 0)]}">
                        <field name="history_count" widget="statinfo" string="Histories"/>
                    </button>
                </xpath>
                <field name="manager_id" position="after">
                    <field name="branch_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)]}"/>
                    <field name="ins_product_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)]}"/>
                    <field name="fraction_ids" placeholder="Insurance fractions" invisible="1"/>
                    <field name="fraction_id" widget="selection" attrs="{'invisible': [('is_insurance', '!=', True)], 'readonly': [('history_stage', 'not in', (False, %(insurance_management.devis)d))]}"/>
                    <field name="history_stage" options="{'no_open': True}" attrs="{'invisible': [('is_insurance', '!=', True)]}"/>
                </field>
                <field name="partner_id" position="replace">
                    <field name="partner_id" string="Subscriber" attrs="{'required': [('is_insurance', '=', True)]}"/>
                    <field name="property_account_position" placeholder="Fiscal position"
                        attrs="{'invisible': [('partner_id','=', False),('is_insurance', '!=', True)], 'readonly': [('history_stage', 'not in', (False, %(insurance_management.devis)d))]}"/>
                    <field name="insured_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)]}"/>
                </field>
                <field name="code" position="after">
                    <field name="pol_ident" attrs="{'invisible': [('is_insurance', '!=', True)]}"/>
                </field>
            </field>
        </record>

        <record id="act_open_account_analytic_account_view" model="ir.actions.act_window">
            <field name="name">Policy</field>
            <field name="res_model">account.analytic.account</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"default_is_insurance":1, 'default_type':'contract', 'search_default_open':1, 'search_default_pending':1, 'default_manager_id':uid}</field>
            <field name="domain">[('type','=','contract'),('is_insurance','=', True)]</field>
            <field name="search_view_id" ref="account.view_account_analytic_account_search"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new contract.
                </p><p>
                    Use contracts to follow tasks, issues, timesheets or invoicing based on
                    work done, expenses and/or sales orders. Odoo will automatically manage
                    the alerts for the renewal of the contracts to the right salesperson.
                </p>
            </field>
        </record>

        <menuitem id="menu_account_analytic_account"
            parent="insurance_management.menu_root_operation_insurance"
            sequence="20"
            action="act_open_account_analytic_account_view"/>

        <record id="generate_invoice_act_server" model="ir.actions.server">
            <field name="name">Generate Invoice</field>
            <field name="model_id" ref="insurance_management.model_account_analytic_account"/>
            <field name="state">code</field>
            <field name="code">action = self.generate_invoice_for_each_version(cr, uid, context.get('active_ids', []), context=context)</field>
        </record>

        <record id="action_generate_invoice_act_server" model="ir.values">
            <field eval="'client_action_multi'" name="key2"/>
            <field eval="'account.analytic.account'" name="model"/>
            <field name="name">Generate invoice</field>
            <field eval="'ir.actions.server,%d'%generate_invoice_act_server" name="value"/>
        </record>

    </data>
</openerp>
