<?xml version="1.0" encoding="UTF-8"?>
<openerp>
    <data>

        <!--
        <act_window id="act_analytic_history_request"
            name="History"
            res_model="analytic.history"
            src_model="account.analytic.account"
            context="{'default_analytic_id': active_id}"
            view_mode="tree,form"
            view_id="insurance_management.view_analytic_history_tree"
            domain="[('analytic_id', '=', active_id)]"/>
        -->

                    <!--
                    <button name="%(act_analytic_history_request)d" type="action" class="oe_stat_button" icon="fa-calendar" attrs="{'invisible': [('history_count','=', 0)]}">
                        <field name="history_count" widget="statinfo" string="History"/>
                    </button>
                    -->

        <record id="view_account_analytic_account_form" model="ir.ui.view">
            <field name="name">Insurance contract form</field>
            <field name="model">account.analytic.account</field>
            <field name="priority" eval="8"/>
            <field name="inherit_id" eval="False"/>
            <field name="arch" type="xml">
                <form string="Analytic Account">
                    <header>
                        <button string="Validate" icon="gtk-ok" states="draft" type="object" name="open_policy"/>
                        <button string="Confirm" icon="gtk-ok" type="object"
                            name="generateAnalyticLines"
                            attrs="{'invisible': ['|','|',('type','!=','contract'),('invoice_id','!=',False)]}"/>
                        <button string="Make Order" icon="gtk-ok" type="object"
                            name="generateSaleOrder"
                            attrs="{'invisible': ['|','|',('type','!=','contract'),('invoice_id','!=',False)]}"/>
                            <!--attrs="{'invisible': ['|','|',('type','!=','contract'),('invoice_id','!=',False),('prod_line_ids','!=', False)]}"/>-->
                        <button string="Gen Invoice" type="object" name="generateInvoiceAnalyticLine"
                            attrs="{'invisible': ['|',('type','!=','contract'),('invoice_id','!=',False)]}"/>
                        <field name="state" readonly="1" widget="statusbar"
                            statusbar_visible="draft,open,pending,suspend,close,cancelled"
                            statusbar_colors='{"pending":"red", "template":"blue"}'
                            attrs="{'invisible': [('type','!=','view')]}"/>
                        <field name="stage_id" readonly="1" widget="statusbar"
                            attrs="{'invisible': [('type','!=','contract')]}"/>
                    </header>
                    <sheet string="Analytic Account">
                        <div class="oe_right oe_button_box" name="buttons">
                            <button
                                name="open_analytic_history_wiz"
                                class="oe_stat_button"
                                string="New version" type="object"
                                icon="fa-file-o"
                                attrs="{'invisible':[('type','!=','view')]}"/>
                            <button name="open_history_list" class="oe_stat_button" type="object" icon="fa-list-alt" attrs="{'invisible': [('history_count','=', 0)]}">
                                <field name="history_count" widget="statinfo" string="Histories"/>
                            </button>
                            <button name="getInvoices" class="oe_stat_button" type="object" icon="fa-list-alt" attrs="{'invisible': [('invoice_count','=', 0)]}">
                                <field name="invoice_count" widget="statinfo" string="Invoices"/>
                            </button>
                            <button name="getAnalyticLine" class="oe_stat_button" type="object" icon="fa-list-alt" attrs="{'invisible': [('invoice_count','=', 0)]}">
                                <field name="analytic_line_count" widget="statinfo" string="Analytic Lines"/>
                            </button>
                            <button class="oe_stat_button" string="Compare" icon="fa-book" type="object" name="compare_trisk_hist" attrs="{'invisible': [('ver_parent_id','=', False)]}"/>
                        </div>

                        <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                            <h1>
                                <field name="name" class="oe_inline" attrs="{'readonly': [('invoice_id', '!=', False)]}"/>
                            </h1>
                            <div name="project"/>
                            <div name="insurance" attrs="{'readonly': [('invoice_id', '!=', False)]}">
                                <field name="is_insurance" attrs="{'readonly': [('invoice_id', '!=', False)]}"/>
                                <label for="is_insurance"/>
                                <field name="is_recurrent" attrs="{'invisible': [('type', '!=', 'view')], 'readonly': [('invoice_id', '!=', False)]}"/>
                                <label for="is_recurrent" attrs="{'invisible': [('type', '!=', 'view')]}"/>
                                <field name="is_last_situation" attrs="{'invisible': [('type', '=', 'view')], 'readonly': [('invoice_id', '!=', False)]}"/>
                                <label for="is_last_situation" attrs="{'invisible': [('type', '=', 'view')]}"/>
                            </div>
                        </div>

                        <group name="main">
                            <group>
                                <!--<field name="partner_id" on_change="on_change_partner_id(partner_id, name)"/>-->
                                <field name="partner_id" string="Subscriber" attrs="{'required': [('is_insurance', '=', True)], 'readonly': [('invoice_id', '!=', False)]}"/>
                                <field name="property_account_position" placeholder="Fiscal position"
                                    attrs="{'invisible': [('partner_id','=', False),('is_insurance', '!=', True)], 'readonly': ['|',('history_stage', 'not in', (False, %(insurance_management.devis)d)),('invoice_id','!=', False)]}"/>
                                <field name="insured_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)], 'readonly': [('invoice_id', '!=', False)]}"/>
                                <field name="manager_id" context="{'default_groups_ref': ['base.group_user', 'base.group_partner_manager', 'account.group_account_manager']}"
                                     attrs="{'readonly': [('invoice_id', '!=', False)]}"/>
                                <field name="branch_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)], 'readonly':[('type','=','contract')]}"/>
                                <field name="ins_product_id" attrs="{'required': [('is_insurance', '=', True)], 'invisible': [('is_insurance', '!=', True)], 'readonly':[('type','=','contract')]}"/>
                                <field name="fraction_ids" placeholder="Insurance fractions" invisible="1"/>
                                <field name="fraction_id" widget="selection" attrs="{'invisible': [('is_insurance', '!=', True)], 'readonly': [('history_stage', 'not in', (False, %(insurance_management.devis)d))], 'readonly':[('type','=','contract')]}"/>
                                <field name="history_stage" options="{'no_open': True}" attrs="{'invisible': [('is_insurance', '!=', True)]}"/>
                                <!--<field name="currency_id" attrs="{'invisible': ['|',('type', '&lt;&gt;', 'view'), ('company_id', '&lt;&gt;', False)]}"/>-->
                                <field name="currency_id" attrs="{'invisible': [('type', '!=', 'view')]}"/>
                                <field name="order_id"/>
                            </group>
                            <group>
                                <!--<field name="type" invisible="context.get('default_type', False)"/>-->
                                <field name="type" groups="base.group_erp_manager"/>
                                <field name="ver_parent_id" attrs="{'invisible': [('ver_parent_id','=', False)]}"/>
                                <field name="code" invisible="1"/>
                                <field name="pol_ident" attrs="{'invisible': [('is_insurance', '!=', True)]}" groups="base.group_erp_manager"/>
                                <!--<field name="parent_id" on_change="on_change_parent(parent_id)" attrs="{'invisible': [('type', '=', 'view')]}"/>-->
                                <field name="parent_id" attrs="{'invisible': [('type', '=', 'view')]}"/>
                                <field name="company_id" on_change="on_change_company(company_id)" widget="selection" groups="base.group_multi_company" attrs="{'required': [('type','&lt;&gt;','view')]}"/>
                                <field name="date_start"/>
                                <field name="date"/>
                                <field name="nb_of_days"/>
                                <field name="agency_id"/>
                                <field name="next_sequence"/>
                                <label for="force_acs" string="Force accessories" attrs="{'invisible': [('type', '=', 'view')]}"/>
                                <div name="force_acs" attrs="{'invisible': [('type', '=', 'view')]}">
                                    <field name="force_acs" class="oe_inline"/>
                                    <field name="accessories" class="oe_inline" attrs="{'invisible': [('force_acs','=', False)]}"/>
                                </div>
                                <field name="capital" attrs="{'invisible': [('type', '=', 'view')]}"/>
                                <field name="eml" attrs="{'invisible': [('type', '=', 'view')]}"/>
                                <field name="invoice_id" attrs="{'invisible': ['|',('invoice_id','=', False),('type', '=', 'view')]}"/>
                                <field name="commission_invoice_id" attrs="{'invisible': ['|',('commission_invoice_id','=', False),('type', '=', 'view')]}"/>
                            </group>
                        </group>
                        <notebook>
                            <page name="Risk Line" string="Risk Line" attrs="{'invisible': [('type', '=', 'view')]}">
                                <field name="risk_line_ids" context="{'default_analytic_id': parent_id}">
                                    <tree string="Risk Line">
                                        <field name="insured_id" invisible="1"/>
                                        <field name="partner_id"/>
                                        <field name="type_risk_id"/>
                                        <field name="name"/>
                                        <field name="parent_id" groups="insurance_management.group_insurance_sale_manager"/>
                                    </tree>
                                    <form string="Risk Line">
                                        <group colspan="4">
                                            <!--<field name="history_id" invisible="0"/>-->
                                            <field name="analytic_id" invisible="1"/>
                                            <field name="ins_product_id" invisible="1"/>
                                            <field name="insured_id" invisible="1"/>
                                            <field name="partner_id" required="context.get('insurance_person', False)" invisible="not context.get('insurance_person', False)"/>
                                            <field name="type_risk_id" string="Risk Type"/>
                                            <field name="name" required="True"/>
                                            <field name="parent_id" readonly="True"/>
                                            <field name="risk_warranty_tmpl_id" string="Warranty Lines Template" attrs="{'invisible': ['|', ('partner_id', '=', False), ('type_risk_id','=', False)]}"/>
                                        </group>
                                        <notebook colspan="4" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                            <page string="Descriptions" name="Descriptions" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                                <field name="risk_description_ids">
                                                    <tree string="Descriptions" create="false" editable='top'>
                                                        <field name="code" readonly="1"/>
                                                        <field name="name" readonly="1"/>
                                                        <field name="value"/>
                                                        <field name="parent_id"/>
                                                    </tree>
                                                </field>
                                            </page>
                                            <page string="Warranty" name="Warranty" attrs="{'invisible': [('type_risk_id','=', False)]}">
                                                <field name="warranty_line_ids" context="{'type_risk_id': type_risk_id}">
                                                    <tree string="warranty" name="warranty" editable="top">
                                                        <field name="warranty_id"/>
                                                        <field name="name"/>
                                                        <field name="yearly_net_amount"/>
                                                        <field name="proratee_net_amount"/>
                                                        <field name="invoiced"/>
                                                        <field name="parent_id"/>
                                                    </tree>
                                                </field>
                                            </page>
                                        </notebook>
                                        <group colspan="4">
                                            <field name="sor_ident" placeholder="comment"/>
                                        </group>
                                    </form>
                                </field>
                            </page>
                            <page string="Warranty" name="Warranty" attrs="{'invisible': [('type', '!=', 'view')]}">
                                <field name="warranty_ids">
                                    <tree string="Warranty">
                                        <field name="name"/>
                                        <field name="warranty_id"/>
                                        <field name="proratee_net_amount"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Descriptions Lines" name="Descriptions" attrs="{'invisible': [('type', '!=', 'view')]}">
                                <field name="description_ids">
                                    <tree string="Descriptions">
                                        <field name="name"/>
                                        <field name="value"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Lines" name="Lines" attrs="{'invisible': [('type', '=', 'view')]}">
                                <field name="line_ids">
                                    <tree string="Lines">
                                        <field name="product_id"/>
                                        <field name="journal_id"/>
                                        <field name="amount_to_invoice"/>
                                        <field name="amount"/>
                                        <field name="date"/>
                                        <field name="currency_id"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Prod Lines" name="Prod Lines" attrs="{'invisible': [('type', '=', 'view')]}">
                                <field name="prod_line_ids" readonly="1">
                                    <tree string="Lines">
                                        <field name="product_id"/>
                                        <field name="journal_id"/>
                                        <field name="amount"/>
                                        <field name="date"/>
                                    </tree>
                                </field>
                            </page>
                            <!--
                            <page string="Contract Information" name="contract_page" attrs="{'invisible':[('type','not in',['contract', 'template'])]}">
                                <group string="Renewal" name="contract">
                                    <p colspan="2" class="oe_grey oe_edit_only">
                                        Once the end date of the contract is
                                        passed or the maximum number of service
                                        units (e.g. support contract) is
                                        reached, the account manager is notified
                                        by email to renew the contract with the
                                        customer.
                                    </p>
                                    <field name="date_start"/>
                                    <label for="date" string="End Date"/>
                                    <div name="duration">
                                        <field name="date" class="oe_inline"/>
                                    </div>
                                </group>
                                <separator string="Terms and Conditions" name="description"/>
                                <field name="description"/>
                            </page>
                            -->
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <record id="view_account_analytic_account_policy_tree" model="ir.ui.view">
            <field name="name">account.analytic.account.tree</field>
            <field name="model">account.analytic.account</field>
            <field name="type">tree</field>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <tree toolbar="1" create="false" colors="red:state=='pending';grey:state in ('cancelled','close');blue:type=='view'" string="Analytic Accounts">
                    <field name="complete_name"/>
                    <field name="partner_id"/>
                    <field name="code" invisible="1"/>
                    <field name="date_start"/>
                    <field name="date"/>
                    <field name="user_id" invisible="1"/>
                    <field name="manager_id" invisible="1"/>
                    <field name="parent_id" invisible="1"/>
                    <field name="state" invisible="1"/>
                    <field name="type" invisible="1"/>
                    <field name="template_id" invisible="1"/>
                    <field name="is_last_situation"/>
                    <field name="company_id" groups="base.group_multi_company"/>
                </tree>
            </field>
        </record>

        <record id="view_aaa_tree_inherit_r0" model="ir.ui.view">
            <field name="name">account.analytic.account.tree.inh</field>
            <field name="model">account.analytic.account</field>
            <field name="inherit_id" ref="account.view_account_analytic_account_list"/>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='code']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
            </field>
        </record>

        <!--open list of version-->
        <record id="act_open_account_analytic_account_view" model="ir.actions.act_window">
            <field name="name">Version</field>
            <field name="res_model">account.analytic.account</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"default_is_insurance":1, 'default_type':'contract', 'search_default_open':1, 'search_default_pending':1, 'default_manager_id':uid, 'default_state': 'draft'}</field>
            <field name="domain">[('type','=','contract'),('is_insurance','=', True)]</field>
            <field name="search_view_id" ref="account.view_account_analytic_account_search"/>
            <field name="view_id" ref="insurance_management.view_account_analytic_account_form"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new contract.
                </p><p>
                    Use contracts to follow tasks, issues, timesheets or invoicing based on
                    work done, expenses and/or sales orders. Odoo will automatically manage
                    the alerts for the renewal of the contracts to the right salesperson.
                </p>
            </field>
        </record>

        <record id="action_acc_analytic_tree_view1" model="ir.actions.act_window.view">
            <field name="sequence" eval="0"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="account.view_account_analytic_account_list"/>
            <field name="act_window_id" ref="insurance_management.act_open_account_analytic_account_view"/>
        </record>

        <menuitem id="menu_account_analytic_account"
            parent="insurance_management.menu_root_operation_insurance"
            sequence="20"
            action="act_open_account_analytic_account_view"/>

        <!--open list of analytic view-->
        <record id="act_open_account_analytic_main_view" model="ir.actions.act_window">
            <field name="name">Policy</field>
            <field name="res_model">account.analytic.account</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"default_is_insurance":1, 'default_type':'view', 'search_default_open':1, 'search_default_pending':1, 'default_manager_id':uid, 'default_state': 'draft'}</field>
            <field name="domain">[('type','=','view'),('is_insurance','=', True)]</field>
            <field name="search_view_id" ref="account.view_account_analytic_account_search"/>
            <field name="view_id" ref="insurance_management.view_account_analytic_account_form"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new contract.
                </p><p>
                    Use contracts to follow tasks, issues, timesheets or invoicing based on
                    work done, expenses and/or sales orders. Odoo will automatically manage
                    the alerts for the renewal of the contracts to the right salesperson.
                </p>
            </field>
        </record>

        <record id="action_acc_analytic_tree_main_view1" model="ir.actions.act_window.view">
            <field name="sequence" eval="0"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="account.view_account_analytic_account_list"/>
            <field name="act_window_id" ref="insurance_management.act_open_account_analytic_main_view"/>
        </record>

        <menuitem id="menu_account_analytic_account_main"
            parent="insurance_management.menu_root_operation_insurance"
            sequence="20"
            action="act_open_account_analytic_main_view"/>

        <record id="generate_invoice_act_server" model="ir.actions.server">
            <field name="name">Generate Invoice</field>
            <field name="model_id" ref="insurance_management.model_account_analytic_account"/>
            <field name="state">code</field>
            <field name="code">action = self.generate_invoice_for_each_version(cr, uid, context.get('active_ids', []), context=context)</field>
        </record>

        <record id="action_generate_invoice_act_server" model="ir.values">
            <field eval="'client_action_multi'" name="key2"/>
            <field eval="'account.analytic.account'" name="model"/>
            <field name="name">Generate invoice</field>
            <field eval="'ir.actions.server,%d'%generate_invoice_act_server" name="value"/>
        </record>

    </data>
</openerp>
